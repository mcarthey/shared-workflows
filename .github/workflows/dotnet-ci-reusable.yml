# Reusable CI workflow for .NET MAUI + API projects
#
# Convergence target for RepWizard and CrewTrack. Implements the principles
# from https://learnedgeek.com/Blog/Post/anatomy-of-a-ci-workflow
#
# Usage in a consuming repository:
#
#   jobs:
#     ci:
#       uses: mcarthey/shared-workflows/.github/workflows/dotnet-ci-reusable.yml@main
#       permissions:
#         contents: read
#         pull-requests: write
#         checks: write
#       with:
#         solution-filter: "MyProject.CI.slnf"
#         maui-project: "MyProject.App/MyProject.App.csproj"
#         smoke-test-url: "http://localhost:5099/health"
#         smoke-test-cwd: "MyProject.Api"
#         smoke-test-env: "Jwt__Secret=CI-Key-32-Chars-Minimum-For-HMAC!"
#       secrets: inherit
#
# IMPORTANT — Caller permissions:
#   The caller must grant permissions that this workflow's jobs need.
#   Repos with default_workflow_permissions=read (recommended) require:
#     permissions:
#       contents: read
#       pull-requests: write   # for pr-summary job
#       checks: write          # for pr-summary job
#
# Codecov:
#   Set codecov-enabled: true and ensure CODECOV_TOKEN is in repo secrets.
#   Test projects need JunitXml.TestLogger NuGet package for test analytics.

name: .NET CI (Reusable)

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: ".NET SDK version"
        type: string
        default: "9.0.x"
      solution-filter:
        description: "Solution filter (.slnf) for non-MAUI build+test"
        type: string
        required: true
      test-settings:
        description: "Path to coverage.runsettings file"
        type: string
        default: "./coverage.runsettings"
      node-version:
        description: "Node.js version (skip if empty)"
        type: string
        default: ""
      pre-build-script:
        description: "Shell script to run before restore (e.g., Tailwind CSS, custom setup)"
        type: string
        default: ""
      maui-project:
        description: "MAUI App .csproj path (skip MAUI job if empty)"
        type: string
        default: ""
      maui-ui-project:
        description: "MAUI UI .csproj path (skip if empty)"
        type: string
        default: ""
      maui-runner:
        description: "Runner for MAUI build (macos-15 or ubuntu-latest)"
        type: string
        default: "macos-15"
      maui-target-framework:
        description: "Target framework for MAUI compile check"
        type: string
        default: "net9.0-android"
      maui-workload:
        description: "MAUI workload to install (maui, maui-android, etc.)"
        type: string
        default: "maui"
      maui-pre-build-script:
        description: "Shell script to run in MAUI job before build (e.g., Tailwind CSS)"
        type: string
        default: ""
      smoke-test-url:
        description: "Health check URL for smoke test (skip if empty)"
        type: string
        default: ""
      smoke-test-cwd:
        description: "Working directory for smoke test (API project folder)"
        type: string
        default: ""
      smoke-test-env:
        description: "Space-separated KEY=VALUE env vars for smoke test"
        type: string
        default: ""
      codecov-enabled:
        description: "Upload coverage to Codecov (requires CODECOV_TOKEN secret)"
        type: boolean
        default: false
      test-timeout-minutes:
        description: "Timeout for build-and-test job"
        type: number
        default: 15
      maui-timeout-minutes:
        description: "Timeout for MAUI build job"
        type: number
        default: 30

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    # fromJSON required: type=number inputs arrive as strings in expressions
    timeout-minutes: ${{ fromJSON(inputs.test-timeout-minutes) }}
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/global.json', '**/Directory.Build.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Setup Node.js
        if: inputs.node-version != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Pre-build setup
        if: inputs.pre-build-script != ''
        run: ${{ inputs.pre-build-script }}

      - name: Restore
        run: dotnet restore ${{ inputs.solution-filter }}

      - name: Build
        run: dotnet build ${{ inputs.solution-filter }} --no-restore -c Release

      - name: Test with coverage
        run: |
          EXTRA_LOGGERS=""
          if [ "${{ inputs.codecov-enabled }}" = "true" ]; then
            EXTRA_LOGGERS='--logger "junit;LogFileName=test-results.xml"'
          fi
          dotnet test ${{ inputs.solution-filter }} \
            --no-build -c Release \
            --settings ${{ inputs.test-settings }} \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=normal" \
            $EXTRA_LOGGERS \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: Smoke test
        if: inputs.smoke-test-url != ''
        run: |
          cd ${{ inputs.smoke-test-cwd }}

          # Export env vars from input
          for pair in ${{ inputs.smoke-test-env }}; do
            export "$pair"
          done

          # Use --no-launch-profile to prevent launchSettings.json from
          # overriding env vars. The caller controls ASPNETCORE_ENVIRONMENT
          # via smoke-test-env (some projects need Development, others don't).
          dotnet run --no-build -c Release --no-launch-profile &
          API_PID=$!

          for i in $(seq 1 30); do
            if curl -s ${{ inputs.smoke-test-url }} > /dev/null 2>&1; then
              echo "API started after ${i}s"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "API failed to start within 30s"
              kill $API_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          RESPONSE=$(curl -s -f ${{ inputs.smoke-test-url }})
          echo "Health: $RESPONSE"
          kill $API_PID 2>/dev/null || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/
          retention-days: 14

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: TestResults/**/coverage.cobertura.xml
          retention-days: 14

      - name: Upload coverage to Codecov
        if: inputs.codecov-enabled
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./TestResults/**/coverage.cobertura.xml
          flags: unittests
          fail_ci_if_error: false

      - name: Upload test results to Codecov
        if: inputs.codecov-enabled && !cancelled()
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./TestResults/**/*.xml
          flags: unittests
          fail_ci_if_error: false

  build-maui:
    name: Build MAUI (compile check)
    runs-on: ${{ inputs.maui-runner }}
    timeout-minutes: ${{ fromJSON(inputs.maui-timeout-minutes) }}
    if: >-
      inputs.maui-project != '' &&
      (github.ref == 'refs/heads/main' || github.event_name == 'pull_request')
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Install MAUI workloads
        run: dotnet workload install ${{ inputs.maui-workload }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-maui-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/global.json', '**/Directory.Build.props') }}
          restore-keys: |
            nuget-maui-${{ runner.os }}-

      - name: Setup Node.js
        if: inputs.node-version != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: MAUI pre-build setup
        if: inputs.maui-pre-build-script != ''
        run: ${{ inputs.maui-pre-build-script }}

      - name: Restore & Build MAUI
        run: |
          # Restore with EnableWindowsTargeting so all TFMs resolve on macOS
          # (suppresses NETSDK1100 for net9.0-windows without affecting build).
          # Then build with -f to compile only the target framework we want.
          # Do NOT use -p:TargetFramework on restore — it's a global property
          # that overrides ALL projects in the graph including transitive
          # net9.0 deps, corrupting their assets.json (NETSDK1005).
          if [ -n "${{ inputs.maui-ui-project }}" ]; then
            dotnet restore ${{ inputs.maui-ui-project }} \
              -p:EnableWindowsTargeting=true
            dotnet build ${{ inputs.maui-ui-project }} \
              --no-restore -c Release -f ${{ inputs.maui-target-framework }}
          fi
          dotnet restore ${{ inputs.maui-project }} \
            -p:EnableWindowsTargeting=true
          dotnet build ${{ inputs.maui-project }} \
            --no-restore -c Release -f ${{ inputs.maui-target-framework }}

  pr-summary:
    name: PR test summary
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      checks: write

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: TestResults

      - name: Publish test summary
        uses: dorny/test-reporter@v1
        with:
          name: xUnit test results
          path: "TestResults/**/*.trx"
          reporter: dotnet-trx
          fail-on-error: true
